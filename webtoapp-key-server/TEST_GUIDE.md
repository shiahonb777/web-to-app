# API æµ‹è¯•è„šæœ¬ä½¿ç”¨æŒ‡å—

æœ¬é¡¹ç›®æä¾›äº†ä¸¤ä¸ªå®Œæ•´çš„ API æµ‹è¯•è„šæœ¬ï¼Œç”¨äºå…¨é¢æµ‹è¯•æ‰€æœ‰ Key Server API ç«¯ç‚¹ã€‚

## ğŸ“‹ è„šæœ¬æ¦‚è§ˆ

### 1. Bash ç‰ˆæœ¬ (`test_api.sh`)

**ä¼˜ç‚¹ï¼š**
- âœ… é›¶ä¾èµ–ï¼Œä»…ä½¿ç”¨å†…ç½®å‘½ä»¤ï¼ˆcurlã€bashï¼‰
- âœ… å¿«é€Ÿå¯åŠ¨ï¼Œæ— éœ€ç¯å¢ƒé…ç½®
- âœ… å½©è‰²è¾“å‡ºï¼Œæ˜“äºé˜…è¯»
- âœ… è½»é‡çº§ï¼Œå¯¹ç³»ç»Ÿèµ„æºå ç”¨å°‘

**é€‚ç”¨åœºæ™¯ï¼š**
- CI/CD æµç¨‹é›†æˆ
- å®¹å™¨ç¯å¢ƒæµ‹è¯•
- æœ€å°åŒ–ä¾èµ–çš„ç”Ÿäº§ç¯å¢ƒ
- å¿«é€Ÿè„šæœ¬éªŒè¯

### 2. Python ç‰ˆæœ¬ (`test_api.py`)

**ä¼˜ç‚¹ï¼š**
- âœ… æ›´å¥½çš„ç»“æ„åŒ–ä»£ç ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- âœ… æä¾›è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šå’Œç»Ÿè®¡
- âœ… æ›´çµæ´»çš„æµ‹è¯•ç¼–æ’å’Œæ¡ä»¶æ§åˆ¶
- âœ… æ”¯æŒå‘½ä»¤è¡Œå‚æ•°

**é€‚ç”¨åœºæ™¯ï¼š**
- å¼€å‘å’Œè°ƒè¯•
- å¤æ‚çš„æµ‹è¯•åœºæ™¯
- éœ€è¦è¯¦ç»†æŠ¥å‘Šçš„æƒ…å†µ
- å›¢é˜Ÿåä½œå¼€å‘

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶

1. **Key Server éœ€è¦è¿è¡Œ**
```bash
# åœ¨ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ Key Server
cd /Users/betty/web-to-app/webtoapp-key-server
make build
./bin/keyserver
```

2. **Bash è„šæœ¬ï¼ˆä»…éœ€ curlï¼‰**
```bash
# curl é€šå¸¸å·²é¢„è£…åœ¨ macOS ä¸Š
curl --version
```

3. **Python è„šæœ¬ï¼ˆéœ€è¦ Python 3.6+ï¼‰**
```bash
# æ£€æŸ¥ Python ç‰ˆæœ¬
python3 --version

# å®‰è£…ä¾èµ–
pip3 install requests
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1ï¼šä½¿ç”¨ Bash è„šæœ¬

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/betty/web-to-app/webtoapp-key-server

# ä½¿ç”¨é»˜è®¤å‚æ•° (localhost:8080)
./test_api.sh

# æŒ‡å®šè‡ªå®šä¹‰ä¸»æœºå’Œç«¯å£
./test_api.sh 192.168.1.100 9080

# å®Œæ•´ç¤ºä¾‹
./test_api.sh example.com 8080
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ WebToApp Key Server API æµ‹è¯•                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æœåŠ¡å™¨åœ°å€: http://localhost:8080
æµ‹è¯•åº”ç”¨ ID: com.webtoapp.test.1733747400

[âœ“ PASS] æœåŠ¡å™¨è¿æ¥æ­£å¸¸

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1ï¸âƒ£  å¥åº·æ£€æŸ¥æµ‹è¯•                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[TEST] å¥åº·æ£€æŸ¥
[âœ“ PASS] å¥åº·æ£€æŸ¥ (2.15ms)
```

### æ–¹æ³• 2ï¼šä½¿ç”¨ Python è„šæœ¬

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/betty/web-to-app/webtoapp-key-server

# ä½¿ç”¨é»˜è®¤å‚æ•° (localhost:8080)
python3 test_api.py

# æŒ‡å®šè‡ªå®šä¹‰å‚æ•°
python3 test_api.py --host 192.168.1.100 --port 9080

# å®Œæ•´ç¤ºä¾‹
python3 test_api.py --host example.com --port 8080

# è·å–å¸®åŠ©
python3 test_api.py --help
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
WebToApp Key Server API å®Œæ•´æµ‹è¯•

æœåŠ¡å™¨åœ°å€: http://localhost:8080
æµ‹è¯•åº”ç”¨ ID: com.webtoapp.test.1733747400

æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨è¿æ¥...
âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1ï¸âƒ£  å¥åº·æ£€æŸ¥æµ‹è¯•                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[TEST] å¥åº·æ£€æŸ¥
[âœ“ PASS] å¥åº·æ£€æŸ¥ (1.23ms)
...
```

## ğŸ§ª æµ‹è¯•è¦†ç›–èŒƒå›´

### 1ï¸âƒ£ å¥åº·æ£€æŸ¥ (Health Check)
```
âœ“ æœåŠ¡å™¨è¿æ¥æ£€æŸ¥
âœ“ API å¥åº·çŠ¶æ€éªŒè¯
âœ“ æœåŠ¡ç‰ˆæœ¬ä¿¡æ¯æ£€æŸ¥
```

### 2ï¸âƒ£ ç”Ÿæˆæ¿€æ´»ç  (Generate Codes)
```
âœ“ æ‰¹é‡ç”Ÿæˆ 5 ä¸ªæ¿€æ´»ç 
âœ“ è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´
âœ“ è®¾ç½®æœ€å¤§ä½¿ç”¨æ¬¡æ•°
âœ“ è®¾å¤‡é™åˆ¶é…ç½®
âœ“ ç”Ÿæˆå•æ¬¡ä½¿ç”¨ç 
âœ“ ç”Ÿæˆé•¿æœŸæœ‰æ•ˆç ï¼ˆ365 å¤©ï¼‰
```

### 3ï¸âƒ£ éªŒè¯æ¿€æ´»ç  (Verify Codes)
```
âœ“ æ­£å¸¸æ¿€æ´»ç éªŒè¯
âœ“ ç­¾åç”ŸæˆéªŒè¯ï¼ˆHMAC-SHA256ï¼‰
âœ“ è®¾å¤‡ä¿¡æ¯è®°å½•
âœ“ æ— æ•ˆæ¿€æ´»ç å¤„ç†
âœ“ å¤šè®¾å¤‡æ¿€æ´»æ”¯æŒ
âœ“ ä½¿ç”¨æ¬¡æ•°è¿½è¸ª
```

### 4ï¸âƒ£ åˆ—è¡¨æŸ¥è¯¢å’Œç­›é€‰ (List & Filter)
```
âœ“ å…¨é‡æŸ¥è¯¢æ¿€æ´»ç åˆ—è¡¨
âœ“ æŒ‰çŠ¶æ€ç­›é€‰ï¼ˆactive/revokedï¼‰
âœ“ åˆ†é¡µæŸ¥è¯¢
âœ“ æ•°æ®ç»“æ„å®Œæ•´æ€§éªŒè¯
âœ“ æ—¶é—´æˆ³ä¿¡æ¯éªŒè¯
```

### 5ï¸âƒ£ æ’¤é”€æ¿€æ´»ç  (Revoke Codes)
```
âœ“ æ’¤é”€æŒ‡å®šæ¿€æ´»ç 
âœ“ çŠ¶æ€æ›´æ–°éªŒè¯
âœ“ æ’¤é”€åæ— æ³•å†ä½¿ç”¨
âœ“ æ’¤é”€çŠ¶æ€æŸ¥è¯¢
```

### 6ï¸âƒ£ è®¾å¤‡è®°å½•ç®¡ç† (Device Records)
```
âœ“ è®¾å¤‡æ¿€æ´»ä¿¡æ¯è®°å½•
âœ“ å¤šè®¾å¤‡æ”¯æŒéªŒè¯
âœ“ è®¾å¤‡ä¿¡æ¯å­˜å‚¨
âœ“ æ¿€æ´»å†å²è¿½è¸ª
```

### âš¡ æ€§èƒ½æµ‹è¯• (Performance)
```
âœ“ å“åº”æ—¶é—´ç»Ÿè®¡
âœ“ æœ€å¿«/æœ€æ…¢è¯·æ±‚è¯†åˆ«
âœ“ å¹³å‡å“åº”æ—¶é—´è®¡ç®—
âœ“ æ€§èƒ½è¯„çº§
```

## ğŸ“Š æ€§èƒ½è¯„çº§æ ‡å‡†

| å¹³å‡å“åº”æ—¶é—´ | è¯„çº§ | è¯´æ˜ |
|-------------|------|------|
| < 10ms | ğŸŸ¢ ä¼˜ç§€ | æ€§èƒ½é¡¶çº§ |
| 10-50ms | ğŸŸ¢ å¾ˆå¥½ | æ€§èƒ½ä¼˜å¼‚ |
| 50-100ms | ğŸŸ¢ è‰¯å¥½ | æ€§èƒ½æ»¡è¶³è¦æ±‚ |
| > 100ms | ğŸŸ¡ å¯æ¥å— | éœ€è¦ä¼˜åŒ– |

## ğŸ” API ç«¯ç‚¹è¯¦æƒ…

### å¥åº·æ£€æŸ¥
```
GET /api/health
```
**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "Service is healthy",
  "version": "1.0.0"
}
```

### ç”Ÿæˆæ¿€æ´»ç 
```
POST /api/activation/generate
```
**è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "app_id": "com.webtoapp.test",
  "count": 5,
  "expires_in_days": 30,
  "max_uses": 10,
  "device_limit": 3
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "generated": 5,
  "codes": [
    {
      "code": "91e1-3c8--d2d--0c7-",
      "id": 1,
      "expires_at": 1767832880092
    }
  ]
}
```

### éªŒè¯æ¿€æ´»ç 
```
POST /api/activation/verify
```
**è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "code": "91e1-3c8--d2d--0c7-",
  "app_id": "com.webtoapp.test",
  "device_id": "test_device_001",
  "device_info": {
    "device_name": "OPPO A57",
    "model": "OPPO A57",
    "os_version": "13",
    "app_version": "1.0.6"
  },
  "timestamp": 1765240880000
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "activation_id": 1,
    "devices_used": 1,
    "device_limit": 3,
    "remaining_uses": 9
  },
  "signature": "3aeb9909ea1111e0b6db75874863b76b9fd25d6446c5280249efb7a8b00e8821",
  "timestamp": 1765240885
}
```

### åˆ—è¡¨æŸ¥è¯¢
```
GET /api/activation/list?app_id=com.webtoapp.test&page=1&limit=10&status=active
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "total": 50,
  "page": 1,
  "limit": 10,
  "items": [
    {
      "id": 1,
      "code": "91e1-3c8--d2d--0c7-",
      "app_id": "com.webtoapp.test",
      "status": "active",
      "max_uses": 10,
      "used_count": 1,
      "created_at": 1765240880,
      "expires_at": 1767832880
    }
  ]
}
```

### æ’¤é”€æ¿€æ´»ç 
```
DELETE /api/activation/{app_id}/{code}
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šè¿æ¥è¢«æ‹’ç»
```
curl: (7) Failed to connect to localhost port 8080: Connection refused
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ç¡®ä¿ Key Server å·²å¯åŠ¨
make build && ./bin/keyserver

# æ£€æŸ¥æœåŠ¡æ˜¯å¦åœ¨è¿è¡Œ
netstat -an | grep 8080
# æˆ–
lsof -i :8080
```

### é—®é¢˜ 2ï¼šæ— æ•ˆçš„ JSON å“åº”
```
[âœ— FAIL] ç”Ÿæˆ 5 ä¸ªæ¿€æ´»ç  - æ— æ•ˆçš„ JSON å“åº”
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ‰‹åŠ¨æµ‹è¯•ç«¯ç‚¹
curl -X POST http://localhost:8080/api/activation/generate \
  -H "Content-Type: application/json" \
  -d '{"app_id":"test","count":1}'

# æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—
tail -50 logs/server.log
```

### é—®é¢˜ 3ï¼šæ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥
```
[âœ— FAIL] æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
ps aux | grep keyserver

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
lsof -i :8080

# é‡å¯æœåŠ¡å™¨
pkill keyserver
sleep 2
./bin/keyserver
```

## ğŸ“ˆ æŒç»­é›†æˆé›†æˆ

### åœ¨ GitHub Actions ä¸­ä½¿ç”¨

```yaml
name: API Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      keyserver:
        image: webtoapp/keyserver:latest
        ports:
          - 8080:8080
    
    steps:
      - uses: actions/checkout@v2
      - name: Run API tests
        run: |
          cd webtoapp-key-server
          bash test_api.sh localhost 8080
```

### åœ¨æœ¬åœ° CI ä¸­ä½¿ç”¨

```bash
#!/bin/bash
# ci_test.sh

set -e

# å¯åŠ¨æœåŠ¡å™¨
./bin/keyserver &
SERVER_PID=$!

# ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
sleep 2

# è¿è¡Œæµ‹è¯•
./test_api.sh localhost 8080

# è·å–æµ‹è¯•ç»“æœ
TEST_RESULT=$?

# åœæ­¢æœåŠ¡å™¨
kill $SERVER_PID

# è¿”å›æµ‹è¯•ç»“æœ
exit $TEST_RESULT
```

## ğŸ“ è‡ªå®šä¹‰æµ‹è¯•

### æ‰©å±• Bash è„šæœ¬

åœ¨ `test_api.sh` ä¸­æ·»åŠ è‡ªå®šä¹‰æµ‹è¯•ï¼š

```bash
# æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹
run_test \
    "è‡ªå®šä¹‰æµ‹è¯•åç§°" \
    "POST" \
    "/api/your-endpoint" \
    '{"param1":"value1"}' \
    "200"
```

### æ‰©å±• Python è„šæœ¬

```python
# æ·»åŠ æ–°çš„æµ‹è¯•æ–¹æ³•åˆ° APITester ç±»
def test_custom_feature(self):
    """è‡ªå®šä¹‰åŠŸèƒ½æµ‹è¯•"""
    self.print_header("è‡ªå®šä¹‰æµ‹è¯•")
    
    response, _ = self.run_test(
        "è‡ªå®šä¹‰æµ‹è¯•åç§°",
        "POST",
        "/api/your-endpoint",
        {"param1": "value1"},
        200
    )
    
    # æ·»åŠ è‡ªå®šä¹‰éªŒè¯
    if response.get('your_field'):
        self.print_success("éªŒè¯é€šè¿‡")
    else:
        self.print_fail("éªŒè¯å¤±è´¥")
```

ç„¶ååœ¨ `run_all_tests()` ä¸­è°ƒç”¨ï¼š
```python
def run_all_tests(self):
    # ... existing tests ...
    self.test_custom_feature()
    # ...
```

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æ£€æŸ¥ Key Server æ—¥å¿—
2. å‚è€ƒ API æ–‡æ¡£
3. åœ¨ README.md ä¸­æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯

## ğŸ“„ è®¸å¯è¯

æœ¬æµ‹è¯•è„šæœ¬éš WebToApp Key Server é¡¹ç›®ä¸€èµ·å‘å¸ƒã€‚
